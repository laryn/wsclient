<?php
// $Id$

/**
 * @file
 * Web service client SOAP support.
 */

/**
 * Implements hook_wsclient_endpoint_types().
 */
function wsclient_soap_endpoint_types() {
  return array(
    'soap' => array(
      'label' => t('SOAP'),
      'class' => 'RulesSOAPEndpoint',
    ),
  );
}

/**
 * A remote endpoint types for invoking SOAP services.
 */
class WSClientSOAPEndpoint implements WSClientEndpointInterface {

  /**
   * @var WSClientServiceDescription
   */
  protected $service;

  protected $url;

  protected  $client;

  public function __construct(WSClientServiceDescription $service) {
    $this->service = $service;
    $this->url = $service->url;
  }

  public function client() {
    if (!isset($this->client)) {
      $options['exceptions'] = TRUE;
      if (!empty($this->service->settings['options'])) {
        $options += $this->service->settings['options'];
      }
      // The url has to point to a WSDL file.
      $this->client = new SOAPClient($this->url, $options);
    }
    return $this->client;
  }

  /**
   * Calls the SOAP service.
   *
   * @param string $operation
   *   The name of the operation to execute.
   * @param array $arguments
   *   Arguments to pass to the service with this operation.
   */
  public function call($operation, $arguments) {
    $operation_url = $this->service->settings['operations'][$operation]['url'];
    $client = $this->client();
    try {
      $response = $client->__soapCall($operation, $arguments);
      return $response;
    }
    catch (RestClientException $e) {
      throw new WSClientException('Error invoking the SOAP service %name, operation %operation: %error', array('%name' => $service->label, '%operation' => $operation, '%error' => $e->getMessage()));
    }
  }

  // This endpoint type doesn't provide events.
  public function events() {}
  public function subscribe($event) {}
  public function unsubscribe($event) {}

  // We don't provide any entites, just register rules data types.
  public function load($type, $id) {}
  public function entities() {}


  public function dataTypes() {
    if (!empty($this->service->settings['data types'])) {
      return $this->service->settings['data types'];
    }
  }

  public function actions() {
    $actions = array();
    foreach ($this->service->settings['operations'] as $name => $operation) {
      $actions[$name] = $operation += array(
        'base' => 'wsclient_soap_call',
        'named parameter' => TRUE,
      );
      $actions[$name]['parameter'] = array();
      // Prefix operation parameter names to avoid name clashes.
      foreach ((array)$operation['parameter'] as $param => $info) {
        $actions[$name]['parameter']['param_' . $param] = $info;
      }
      $actions[$name]['parameter']['remote'] = array(
        'type' => 'hidden',
        'default value' => $this->service->name,
      );
      $actions[$name]['parameter']['operation'] = array(
        'type' => 'hidden',
        'default value' => $name,
      );
      if (!empty($actions[$name]['provides'])) {
        $names = array_keys($actions[$name]['provides']);
        $actions[$name]['provides'] = array('var' => reset($actions[$name]['provides']));
        $actions[$name]['provides']['var']['label'] = $names[0];
      }
    }
    return $actions;
  }

  public function conditions() {}
  public function formAlter(&$form, &$form_state) { }
}

/**
 * Action callback: Invoke a SOAP operation.
 */
function wsclient_soap_call($arguments, RulesPlugin $element) {
  if ($service = wsclient_service_load($arguments['remote'])) {
    $client = $service->endpoint()->client();
    try {
      $soap_args = array();
      foreach ($arguments as $name => $data) {
        if (strpos($name, 'param_') === 0) {
          // Remove the parameter name prefix 'param_'.
          $soap_args[substr($name, 6)] = $data;
        }
      }
      $return = $client->__call($arguments['operation'], $soap_args);
      return array('var' => $return);
    }
    catch (SoapFault $e) {
      throw new WSClientException('Error invoking the SOAP service of the remote %name: %error', array('%name' => $service->label, '%error' => $e->getMessage()));
    }
  }
  else {
    throw new WSClientException('The web service %name cannot be found.', array('%name' => $arguments['remote']), $element, RulesLog::ERROR);
  }
}
